%%{init: {
  "theme": "base",
  "themeVariables": {
    "primaryColor": "#FDE68A",
    "primaryTextColor": "#0B1020",
    "primaryBorderColor": "#0B1020",
    "lineColor": "#0B1020",
    "actorBorder": "#0B1020",
    "actorBkg": "#BFDBFE",
    "actorTextColor": "#0B1020",
    "signalColor": "#0B1020",
    "sequenceNumberColor": "#0B1020",
    "noteBkgColor": "#FEF3C7",
    "noteTextColor": "#0B1020",
    "noteBorderColor": "#F59E0B"
  },
  "themeCSS": ".actor rect{stroke-width:2.5px}.actor text{font-weight:700}.messageLine0,.messageLine1,.messageLine2,.messageLine3{stroke-width:2.5px}.sequenceNumber{fill:#0B1020;font-weight:700}.label, .loopText{font-weight:700}.note{stroke-width:2px}"
} }%%
sequenceDiagram
  autonumber
  participant Client
  participant GW as Gateway
  participant ORD as Orders
  participant DB as Orders DB
  participant K as Kafka
  participant INV as Inventory
  participant PAY as Payments

  Client->>GW: POST /orders (items, Idempotency-Key)
  GW->>ORD: CreateOrder(customerId, items)
  ORD->>DB: Insert order (PENDING)
  DB-->>ORD: ok (orderId)
  ORD->>K: publish OrderCreated (oms.order.v1)
  ORD-->>GW: 201 {orderId}
  GW-->>Client: 201 {orderId}

  par Inventory path
    K-->>INV: OrderCreated
    INV->>INV: Reserve stock
    alt Reservation OK
      INV->>K: InventoryReserved (oms.inventory.v1)
    else Out of stock
      INV->>K: InventoryRejected (oms.inventory.v1)
    end
  and Orders reacts
    K-->>ORD: InventoryReserved | InventoryRejected
    alt Reserved
      ORD->>DB: Update status VALIDATED
      ORD->>K: OrderValidated
      K-->>PAY: OrderValidated
      PAY->>PAY: Authorize payment
      alt Payment OK
        PAY->>K: PaymentAuthorized (oms.payment.v1)
        K-->>ORD: PaymentAuthorized
        ORD->>DB: Update status PAID
        ORD->>K: OrderPaid
      else Payment Failed
        PAY->>K: PaymentFailed (oms.payment.v1)
        K-->>ORD: PaymentFailed
        ORD->>DB: Update status CANCELLED
        ORD->>K: OrderCancelled
      end
    else Rejected
      ORD->>DB: Update status CANCELLED
      ORD->>K: OrderCancelled
    end
  end
